<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿåå°ç®¡ç†</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 40px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; background: #d9534f; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; }
        .btn:hover { background: #c9302c; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        #status { margin-top: 20px; padding: 10px; border-radius: 6px; display: none; text-align: center; }
        .success { background: #dff0d8; color: #3c763d; }
        .error { background: #f2dede; color: #a94442; }
        .back-link { display: block; text-align: center; margin-top: 20px; color: #666; text-decoration: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ çŸ¥è¯†åº“åå°ç®¡ç†</h1>
        <p style="color: #666; text-align: center; margin-bottom: 30px;">
            ä¸€é”®çˆ¬å–æœ€æ–°æŠ¥å‘Šå¹¶æ›´æ–°å‘é‡æ•°æ®åº“
        </p>

        <div class="form-group">
            <label>ç®¡ç†å‘˜å¯†ç :</label>
            <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
        </div>

        <div class="form-group">
            <label>Gemini API Key (ç”¨äºå‘é‡ç”Ÿæˆ):</label>
            <input type="password" id="embeddingKey" placeholder="è¾“å…¥ Key">
            <small style="color: #999;">å¦‚æœç³»ç»Ÿå·²é…ç½®å…¨å±€Keyï¼Œæ­¤å¤„å¯ç•™ç©º(éœ€ä¿®æ”¹ä»£ç é€‚é…)</small>
        </div>

        <button class="btn" id="updateBtn" onclick="performUpdate()">ğŸ”„ ä¸€é”®æ£€æµ‹å¹¶æ›´æ–°çŸ¥è¯†åº“</button>
        
        <div id="status"></div>
        
        <a href="/" class="back-link">â† è¿”å›é¦–é¡µ</a>
    </div>

    <script>
        // å°è¯•è‡ªåŠ¨å¡«å……Key
        document.getElementById('embeddingKey').value = localStorage.getItem('globalGeminiKey') || '';

        // è‡ªåŠ¨æ£€æµ‹APIåŸºç¡€URL
        const API_BASE = window.location.origin.includes('5500') || window.location.protocol === 'file:'
            ? 'http://localhost:5001'  // å¦‚æœé€šè¿‡Live Serveræˆ–ç›´æ¥æ‰“å¼€æ–‡ä»¶ï¼Œä½¿ç”¨FlaskæœåŠ¡å™¨åœ°å€
            : '';  // å¦‚æœé€šè¿‡FlaskæœåŠ¡å™¨æ‰“å¼€ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„

        async function performUpdate() {
            const password = document.getElementById('adminPassword').value;
            const apiKey = document.getElementById('embeddingKey').value;
            const btn = document.getElementById('updateBtn');
            const status = document.getElementById('status');

            if (!password) {
                alert('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'æ­£åœ¨å‘é€æŒ‡ä»¤...';
            status.style.display = 'none';

            try {
                const res = await fetch(`${API_BASE}/api/admin/update-db`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ password: password, api_key: apiKey })
                });
                
                // å°è¯•è§£æå“åº”ï¼ˆæ— è®ºçŠ¶æ€ç å¦‚ä½•ï¼‰
                let data;
                try {
                    data = await res.json();
                } catch (jsonError) {
                    // å¦‚æœæ— æ³•è§£æJSONï¼Œä½¿ç”¨çŠ¶æ€ç é”™è¯¯
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                status.style.display = 'block';
                if (res.ok && data.success) {
                    status.className = 'success';
                    status.textContent = 'âœ… ' + data.message;
                } else {
                    status.className = 'error';
                    // æ˜¾ç¤ºåç«¯è¿”å›çš„å…·ä½“é”™è¯¯æ¶ˆæ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºHTTPçŠ¶æ€
                    status.textContent = 'âŒ ' + (data.error || `HTTP ${res.status}: ${res.statusText}`);
                }
            } catch (e) {
                status.style.display = 'block';
                status.className = 'error';
                status.textContent = 'âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + e.message + 'ã€‚è¯·ç¡®ä¿FlaskæœåŠ¡å™¨æ­£åœ¨è¿è¡Œ (http://localhost:5001)';
                console.error('è¯·æ±‚å¤±è´¥:', e);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ ä¸€é”®æ£€æµ‹å¹¶æ›´æ–°çŸ¥è¯†åº“';
            }
        }
    </script>
</body>
</html>