<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAGæ™ºèƒ½æœç´¢å¼•æ“ - è§†é¢‘å†…å®¹åˆ†æå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .navbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            list-style: none;
            margin-bottom: 20px;
            border-radius: 12px;
        }

        .navbar .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-text {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }

        .navbar li:not(.logo) {
            margin-left: 20px;
        }

        .navbar a {
            text-decoration: none;
            color: #333;
            font-size: 16px;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .navbar a:hover {
            background: #667eea;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
            text-align: center;
        }

        .search-section {
            margin-bottom: 30px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-box input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .ai-analysis {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .ai-analysis.show {
            display: block;
        }

        .ai-analysis h3 {
            color: #2196F3;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .ai-analysis .category-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .category-tag {
            background: #2196F3;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        .keyword-tag {
            background: #4CAF50;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        .results-section {
            margin-top: 30px;
        }

        .result-item {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .result-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .result-title {
            font-size: 20px;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .result-meta {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .result-meta span {
            margin-right: 15px;
        }

        .result-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .result-category {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .result-content {
            color: #333;
            line-height: 1.8;
            margin-top: 15px;
            max-height: 200px;
            overflow: hidden;
            position: relative;
        }

        .result-content.expanded {
            max-height: none;
        }

        .result-content p {
            margin: 10px 0;
        }

        .result-content strong {
            font-weight: bold;
            color: #333;
        }

        .result-content em {
            font-style: italic;
        }

        .result-content a {
            color: #667eea;
            text-decoration: underline;
        }

        .expand-btn {
            color: #667eea;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
            text-decoration: underline;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            display: none;
        }

        .no-results.show {
            display: block;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .filter-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-tag {
            padding: 8px 16px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .filter-tag:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .filter-tag.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <nav>
        <ul class="navbar">
            <li class="logo">
                <a href="home.html">
                    <span class="logo-text">ğŸ“¹ è§†é¢‘å†…å®¹åˆ†æå·¥å…·</span>
                </a>
            </li>
            <li><a href="index.html">Video Content Analysis</a></li>
            <li><a href="/index2.html">Expert Opinion Generation (RAG)</a></li>
        </ul>
    </nav>

    <div class="container">
        <h1> RAGæ™ºèƒ½æœç´¢å¼•æ“</h1>
        <p class="subtitle">åŸºäºå‘é‡æ•°æ®åº“çš„æ™ºèƒ½å­¦æœ¯æŠ¥å‘Šæ£€ç´¢ç³»ç»Ÿï¼Œæ”¯æŒè¯­ä¹‰æœç´¢å’Œåˆ†ç±»ç­›é€‰</p>

        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <strong> é…ç½®æç¤ºï¼š</strong>
            <p style="margin: 10px 0 0 0; color: #666;">
                è¯·åœ¨ <a href="index.html" style="color: #667eea;">Video Content Analysis</a> é¡µé¢çš„å…¨å±€é…ç½®ä¸­è¾“å…¥ <strong>Gemini API Key</strong>ï¼Œç”¨äºæŸ¥è¯¢æ„å›¾åˆ†æã€‚
            </p>
        </div>

        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchQuery" placeholder="è¾“å…¥æ‚¨è¦æœç´¢çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼šé’™é’›çŸ¿å¤ªé˜³èƒ½ç”µæ± ã€AIè›‹ç™½è´¨è®¾è®¡ã€é‡å­è®¡ç®—..." style="font-size: 16px;">
                <button class="btn btn-primary" onclick="performSearch()" id="searchBtn">æœç´¢</button>
            </div>

            <div class="ai-analysis" id="aiAnalysis">
                <h3> AIåˆ†æç»“æœ</h3>
                <div id="aiAnalysisContent"></div>
            </div>

            <div class="filter-section">
                <h3> åˆ†ç±»ç­›é€‰</h3>
                <div class="filter-tags" id="categoryFilters">
                </div>
            </div>

            <div class="status" id="searchStatus"></div>
            <div class="loading" id="searchLoading">
                <div class="spinner"></div>
                <p>æ­£åœ¨æœç´¢ï¼Œè¯·ç¨å€™...</p>
            </div>
        </div>  

        <div class="results-section">
            <div class="no-results" id="noResults">
                <p style="font-size: 18px; margin-bottom: 10px;"> æš‚æ— æœç´¢ç»“æœ</p>
                <p>è¯·å°è¯•å…¶ä»–å…³é”®è¯æˆ–æ¸…é™¤ç­›é€‰æ¡ä»¶</p>
            </div>
            <div id="searchResults"></div>
        </div>
    </div>

    <script>
        let API_BASE = window.location.origin;
        const currentPort = window.location.port;
        if (currentPort === '5500' || currentPort === '' || window.location.protocol === 'file:') {
            API_BASE = 'http://localhost:5001';
            console.log('æ£€æµ‹åˆ°Live Serveræˆ–ç›´æ¥æ‰“å¼€æ–‡ä»¶ï¼ŒAPIè¯·æ±‚å°†å‘é€åˆ°:', API_BASE);
        }

        const BROAD_CATEGORIES = [
            "æ•°å­¦", "åŠ›å­¦", "ç‰©ç†å­¦", "åŒ–å­¦", "å¤©æ–‡å­¦", "åœ°çƒç§‘å­¦", "ç”Ÿç‰©å­¦",
            "å†œå­¦", "æ—å­¦", "ç•œç‰§/å…½åŒ»ç§‘å­¦", "æ°´äº§å­¦", "åŒ»è¯å«ç”Ÿ",
            "æµ‹ç»˜ç§‘å­¦æŠ€æœ¯", "ææ–™ç§‘å­¦ä¸å·¥ç¨‹", "å†¶é‡‘å·¥ç¨‹æŠ€æœ¯", "æœºæ¢°ä¸è¿è½½å·¥ç¨‹",
            "æ ¸ç§‘å­¦æŠ€æœ¯", "ç”µå­ä¸é€šä¿¡æŠ€æœ¯", "è®¡ç®—æœºç§‘å­¦æŠ€æœ¯", "åŒ–å­¦å·¥ç¨‹",
            "è½»å·¥çººç»‡ç§‘å­¦æŠ€æœ¯", "é£Ÿå“ç§‘å­¦æŠ€æœ¯", "åœŸæœ¨å»ºç­‘å·¥ç¨‹", "æ°´åˆ©å·¥ç¨‹",
            "äº¤é€šè¿è¾“", "èˆªç©ºèˆªå¤©ç§‘å­¦æŠ€æœ¯", "ç¯å¢ƒåŠèµ„æº", "å®‰å…¨ç§‘å­¦æŠ€æœ¯",
            "ç®¡ç†å­¦", "ç¤¾ä¼šäººæ–‡", "å…¶ä»–"
        ];

        // åˆå§‹åŒ–åˆ†ç±»ç­›é€‰æ ‡ç­¾
        function initCategoryFilters() {
            const filterContainer = document.getElementById('categoryFilters');
            BROAD_CATEGORIES.forEach(category => {
                const tag = document.createElement('span');
                tag.className = 'filter-tag';
                tag.textContent = category;
                tag.onclick = () => toggleCategoryFilter(category, tag);
                filterContainer.appendChild(tag);
            });
        }

        let selectedCategories = [];

        function toggleCategoryFilter(category, element) {
            if (selectedCategories.includes(category)) {
                selectedCategories = selectedCategories.filter(c => c !== category);
                element.classList.remove('active');
            } else {
                selectedCategories.push(category);
                element.classList.add('active');
            }
        }

        function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) {
                showStatus('searchStatus', 'è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'error');
                return;
            }

            // è·å–Gemini API Keyï¼ˆä»localStorageï¼‰
            let geminiKey = '';
            try {
                geminiKey = localStorage.getItem('globalGeminiKey') || '';
            } catch (e) {
                console.log('æ— æ³•ä»localStorageè·å–API Key:', e);
            }
            
            if (!geminiKey) {
                showStatus('searchStatus', 'è¯·åœ¨ <a href="index.html" style="color: #667eea; text-decoration: underline;">Video Content Analysis</a> é¡µé¢çš„å…¨å±€é…ç½®ä¸­è¾“å…¥ Gemini API Key', 'error');
                return;
            }

            showLoading('searchLoading', true);
            hideStatus('searchStatus');
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('noResults').classList.remove('show');
            document.getElementById('aiAnalysis').classList.remove('show');
            document.getElementById('searchBtn').disabled = true;
            
            fetch(`${API_BASE}/api/rag/search`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    query: query,
                    categories: selectedCategories,
                    api_key: geminiKey
                })
            })
            .then(async response => {
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`æœåŠ¡å™¨é”™è¯¯ (${response.status}): ${errorText || response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`æœåŠ¡å™¨è¿”å›é JSON å“åº”: ${text.substring(0, 200)}`);
                }
                
                return response.json();
            })
            .then(data => {
                showLoading('searchLoading', false);
                document.getElementById('searchBtn').disabled = false;

                if (data.success) {
                    // æ˜¾ç¤ºAIåˆ†æç»“æœ
                    if (data.analysis) {
                        displayAIAnalysis(data.analysis);
                    }

                    // æ˜¾ç¤ºæœç´¢ç»“æœ
                    if (data.results && data.results.length > 0) {
                        displayResults(data.results);
                        document.getElementById('noResults').classList.remove('show');
                    } else {
                        document.getElementById('noResults').classList.add('show');
                    }
                } else {
                    showStatus('searchStatus', data.error || 'æœç´¢å¤±è´¥', 'error');
                    document.getElementById('noResults').classList.add('show');
                }
            })
            .catch(error => {
                showLoading('searchLoading', false);
                document.getElementById('searchBtn').disabled = false;
                showStatus('searchStatus', 'æœç´¢å¤±è´¥: ' + error.message, 'error');
                console.error('æœç´¢é”™è¯¯:', error);
            });
        }

        function displayAIAnalysis(analysis) {
            const analysisDiv = document.getElementById('aiAnalysis');
            const contentDiv = document.getElementById('aiAnalysisContent');
            
            let html = '';
            
            if (analysis.categories && analysis.categories.length > 0) {
                html += '<div style="margin-bottom: 15px;"><strong>é”å®šåˆ†ç±»:</strong> ';
                html += '<div class="category-tags">';
                analysis.categories.forEach(cat => {
                    html += `<span class="category-tag">${cat}</span>`;
                });
                html += '</div></div>';
            }

            if (analysis.keywords && analysis.keywords.length > 0) {
                html += '<div><strong>æ‰©å±•å…³é”®è¯:</strong> ';
                html += '<div class="category-tags">';
                analysis.keywords.forEach(kw => {
                    html += `<span class="keyword-tag">${kw}</span>`;
                });
                html += '</div></div>';
            }

            contentDiv.innerHTML = html;
            analysisDiv.classList.add('show');
        }

        // ç®€å•çš„Markdownè½¬HTMLå‡½æ•°ï¼ˆå¤„ç†ç²—ä½“ã€æ–œä½“ã€é“¾æ¥ç­‰ï¼‰
        function markdownToHtml(markdown) {
            if (!markdown) return '';
            
            let html = markdown;
            
            // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦ï¼ˆä½†ä¿ç•™markdownæ ¼å¼ï¼‰
            html = html.replace(/&/g, '&amp;')
                       .replace(/</g, '&lt;')
                       .replace(/>/g, '&gt;');
            
            // å¤„ç†ç²—ä½“ **text** æˆ– __text__
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
            
            // å¤„ç†æ–œä½“ *text* æˆ– _text_
            html = html.replace(/(?<!\*)\*([^*]+?)\*(?!\*)/g, '<em>$1</em>');
            html = html.replace(/(?<!_)_([^_]+?)_(?!_)/g, '<em>$1</em>');
            
            // å¤„ç†é“¾æ¥ [text](url)
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #667eea;">$1</a>');
            
            // å¤„ç†æ¢è¡Œï¼ˆä¸¤ä¸ªæ¢è¡Œç¬¦ä¸ºæ®µè½ï¼Œå•ä¸ªæ¢è¡Œç¬¦ä¸º<br>ï¼‰
            html = html.replace(/\n\n/g, '</p><p>');
            html = html.replace(/\n/g, '<br>');
            
            // åŒ…è£…æ®µè½
            if (html && !html.startsWith('<p>')) {
                html = '<p>' + html + '</p>';
            }
            
            return html;
        }

        function displayResults(results) {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';

            results.forEach((result, index) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result-item';
                
                const metadata = result.metadata || {};
                const summary = result.text || result.content || ''; // è¿™æ˜¯æ ¸å¿ƒæ‘˜è¦
                const fullText = result.full_text || summary; // å®Œæ•´æ–‡æœ¬ä½œä¸ºbackup
                const score = result.score ? `ç›¸ä¼¼åº¦: ${(result.score * 100).toFixed(1)}%` : '';
                
                // å°†markdownè½¬æ¢ä¸ºHTML
                const summaryHtml = markdownToHtml(summary);
                const fullTextHtml = markdownToHtml(fullText);

                let categoriesHtml = '';
                if (metadata.categories && Array.isArray(metadata.categories)) {
                    categoriesHtml = metadata.categories.map(cat => 
                        `<span class="result-category">${cat}</span>`
                    ).join('');
                }

                resultDiv.innerHTML = `
                    <div class="result-header">
                        <div style="flex: 1;">
                            <div class="result-title">${metadata.title || `ç»“æœ ${index + 1}`}</div>
                            <div class="result-meta">
                                ${metadata.speaker ? `<span> æŠ¥å‘Šäºº: ${metadata.speaker}</span>` : ''}
                                ${metadata.organization ? `<span> æœºæ„: ${metadata.organization}</span>` : ''}
                                ${metadata.year ? `<span> å¹´ä»½: ${metadata.year}</span>` : ''}
                                ${metadata.forum ? `<span> è®ºå›: ${metadata.forum}</span>` : ''}
                                ${score ? `<span style="color: #667eea;">${score}</span>` : ''}
                            </div>
                            ${categoriesHtml ? `<div class="result-categories">${categoriesHtml}</div>` : ''}
                        </div>
                    </div>
                    <div class="result-content" id="content-${index}" data-full-content="${fullTextHtml.replace(/"/g, '&quot;')}" data-summary="${summaryHtml.replace(/"/g, '&quot;')}">
                        ${summaryHtml}
                    </div>
                    ${fullText.length > summary.length ? `<div class="expand-btn" id="expand-btn-${index}" onclick="toggleExpand(${index})">å±•å¼€å…¨æ–‡</div>` : ''}
                    ${metadata.original_url ? `<div style="margin-top: 10px;"><a href="${metadata.original_url}" target="_blank" style="color: #667eea; text-decoration: none;"> æŸ¥çœ‹åŸæ–‡</a></div>` : ''}
                `;

                resultsContainer.appendChild(resultDiv);
            });
        }

        function toggleExpand(index) {
            const contentDiv = document.getElementById(`content-${index}`);
            const expandBtn = document.getElementById(`expand-btn-${index}`);
            if (!contentDiv || !expandBtn) return;
            const fullContent = contentDiv.getAttribute('data-full-content');
            const isExpanded = contentDiv.classList.contains('expanded');
            
            if (isExpanded) {
                // æ”¶èµ·ï¼šæ˜¾ç¤ºæ‘˜è¦ï¼ˆä»ç¬¬ä¸€ä¸ªç»“æœä¸­è·å–æ‘˜è¦ï¼‰
                const summary = contentDiv.getAttribute('data-summary') || '';
                contentDiv.innerHTML = summary;
                contentDiv.classList.remove('expanded');
                expandBtn.textContent = 'å±•å¼€å…¨æ–‡';
            } else {
                // å±•å¼€ï¼šæ˜¾ç¤ºå®Œæ•´å†…å®¹
                contentDiv.innerHTML = fullContent;
                contentDiv.classList.add('expanded');
                expandBtn.textContent = 'æ”¶èµ·';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showStatus(id, message, type) {
            const status = document.getElementById(id);
            status.textContent = message;
            status.className = `status ${type} show`;
        }

        function hideStatus(id) {
            document.getElementById(id).classList.remove('show');
        }

        function showLoading(id, show) {
            document.getElementById(id).classList.toggle('show', show);
        }

        document.getElementById('searchQuery').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        initCategoryFilters();
    </script>
</body>
</html>
